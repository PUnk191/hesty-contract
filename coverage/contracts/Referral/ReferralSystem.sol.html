<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\Referral\ReferralSystem.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/Referral/</a> ReferralSystem.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/44</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">7.69% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>1/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">10.81% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>4/37</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">54×</span>
<span class="cline-any cline-yes">54×</span>
<span class="cline-any cline-yes">54×</span>
<span class="cline-any cline-yes">54×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
&nbsp;
import "../interfaces/IReferral.sol";
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "../interfaces/IHestyAccessControl.sol";
import "@openzeppelin/contracts/access/AccessControlDefaultAdminRules.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "../interfaces/ITokenFactory.sol";
&nbsp;
/*
* @notice This referral system is build a part
            from the
*/
contract ReferralSystem is ReentrancyGuard, IReferral {
&nbsp;
     IHestyAccessControl public ctrHestyControl;                    // Hesty Global Access Control
     address             public rewardToken;                        // Token contract address of rewards
     ITokenFactory       public tokenFactory;
&nbsp;
     mapping(address =&gt; mapping(uint256 =&gt;uint256)) public rewards; /// @notice Rewards earned by user indexed to each property
     mapping(address =&gt; uint256) public totalRewards;               /// @notice Total rewards earned by user indexed to properties
     mapping(address =&gt; uint256) public globalRewards;              /// @notice Total rewards earned by user not indexed to properties
     mapping(uint256 =&gt;uint256)  public rewardsByProperty;          /// @notice Total rewards earned by users filtered by property
     mapping(address =&gt; uint256) public numberOfRef;                /// @notice Number of referrals a user has
     mapping(address =&gt; address) public referredBy;                 /// @notice Who reffered the user
     mapping(address =&gt; bool)    public approvedCtrs;               /// @notice Approved addresses that can add property rewards
&nbsp;
    constructor(address rewardToken_, address ctrHestyControl_, address tokenFactory_) {
        rewardToken = rewardToken_;
        ctrHestyControl = IHestyAccessControl(ctrHestyControl_);
        approvedCtrs[tokenFactory_] = true;
        tokenFactory = ITokenFactory(tokenFactory_);
&nbsp;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    modifier whenNotAllPaused(){</span>
<span class="cstat-no" title="statement not covered" >        require(ctrHestyControl.paused(), "All Hesty Paused")</span>;
        _;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    modifier whenKYCApproved(address user){</span>
<span class="cstat-no" title="statement not covered" >        require(ctrHestyControl.kycCompleted(user), "No KYC Made")</span>;
        _;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    modifier whenNotBlackListed(address user){</span>
<span class="cstat-no" title="statement not covered" >        require(ctrHestyControl.blackList(user), "Blacklisted")</span>;
        _;
    }
&nbsp;
    /**
        @dev Checks that `msg.sender` is an Admin
    */
<span class="fstat-no" title="function not covered" >    modifier onlyAdmin(){</span>
<span class="cstat-no" title="statement not covered" >        ctrHestyControl.onlyAdmin(msg.sender)</span>;
        _;
    }
&nbsp;
    /**
        @dev    Add Rewards Associated to a Property Project
        @param  onBehalfOf User who referred and the one that will receive the income
        @param  user The user who were referenced by onBehalfOf user
        @param  projectId The Property project
        @param  amount The amount of rewards
    */
<span class="fstat-no" title="function not covered" >    function addRewards(address onBehalfOf, address user, uint256 projectId, uint256 amount) external whenNotAllPaused{</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        require(approvedCtrs[msg.sender], "Not Approved")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        if(referredBy[user] == address(0)){</span>
            referredBy[user]        = onBehalfOf;
            numberOfRef[onBehalfOf] += 1;
        }
&nbsp;
        rewards[onBehalfOf][projectId] += amount;
        rewardsByProperty[projectId]   += amount;
        totalRewards[onBehalfOf]       += amount;
&nbsp;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function addGlobalRewards(address onBehalfOf, address user, uint256 amount) external whenNotAllPaused{</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        bool txVal = IERC20(rewardToken).transferFrom(msg.sender, address(this), amount);</span>
<span class="cstat-no" title="statement not covered" >        require(txVal, "Something odd happened")</span>;
&nbsp;
&nbsp;
<span class="cstat-no" title="statement not covered" >        if(referredBy[user] == address(0)){</span>
            referredBy[user]        = onBehalfOf;
            numberOfRef[onBehalfOf] += 1;
        }
&nbsp;
        globalRewards[onBehalfOf] += amount;
&nbsp;
&nbsp;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function claimPropertyRewards(address user, uint256 projectId) external nonReentrant whenNotAllPaused whenKYCApproved(msg.sender) whenNotBlackListed(msg.sender){</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        require(tokenFactory.isRefClaimable(projectId), "Not yet")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 rew   = rewards[user][projectId];</span>
        rewards[user][projectId] = 0;
&nbsp;
<span class="cstat-no" title="statement not covered" >        IERC20(rewardToken).transfer(user, rew)</span>;
&nbsp;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function claimGlobalRewards(address user) external nonReentrant whenNotAllPaused whenKYCApproved(msg.sender) whenNotBlackListed(msg.sender){</span>
&nbsp;
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 rew   = globalRewards[user];</span>
        globalRewards[user] = 0;
&nbsp;
<span class="cstat-no" title="statement not covered" >        IERC20(rewardToken).transfer(user, rew)</span>;
&nbsp;
    }
&nbsp;
&nbsp;
    /**
        @dev Return Number of user referrals and user referral revenues
    */
<span class="fstat-no" title="function not covered" >    function getReferrerDetails(address user) external view returns(uint256, uint256, uint256){</span>
<span class="cstat-no" title="statement not covered" >        return(numberOfRef[user], totalRewards[user], globalRewards[user]);</span>
   }
&nbsp;
<span class="fstat-no" title="function not covered" >    function addApprovedCtrs(address newReferralRouter) external onlyAdmin{</span>
        approvedCtrs[newReferralRouter] = true;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function removeApprovedCtrs(address oldReferralRouter) external onlyAdmin{</span>
<span class="cstat-no" title="statement not covered" >        require(approvedCtrs[oldReferralRouter], "Not Approved Router")</span>;
        approvedCtrs[oldReferralRouter] = true;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function setRewardToken(address newToken) external onlyAdmin{</span>
        rewardToken = newToken;
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Oct 06 2024 10:03:03 GMT+0100 (Hora de verão da Europa Ocidental)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
